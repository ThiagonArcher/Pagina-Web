-- Crear la base principal
CREATE DATABASE tienda;
\c tienda

-- Tabla de sucursales (cada réplica representa una)
CREATE TABLE sucursales (
    id SERIAL PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    ciudad VARCHAR(100) NOT NULL,
    direccion TEXT,
    telefono VARCHAR(20)
);

-- Tabla de productos (catálogo común)
CREATE TABLE productos (
    id SERIAL PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    descripcion TEXT,
    precio DECIMAL(10,2) NOT NULL,
    stock INT NOT NULL DEFAULT 0,
    id_sucursal INT REFERENCES sucursales(id) ON DELETE SET NULL
);

-- Tabla de ventas
CREATE TABLE ventas (
    id SERIAL PRIMARY KEY,
    id_producto INT NOT NULL REFERENCES productos(id),
    id_sucursal INT NOT NULL REFERENCES sucursales(id),
    cantidad INT NOT NULL,
    total DECIMAL(10,2) GENERATED ALWAYS AS (cantidad * (SELECT precio FROM productos WHERE productos.id = id_producto)) STORED,
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla para el historial o sincronización
CREATE TABLE inventario (
    id SERIAL PRIMARY KEY,
    id_producto INT NOT NULL REFERENCES productos(id),
    id_sucursal INT NOT NULL REFERENCES sucursales(id),
    cantidad_disponible INT NOT NULL,
    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Crear un usuario para la aplicación web
CREATE USER tienda_user WITH PASSWORD 'tienda123';
GRANT CONNECT ON DATABASE tienda TO tienda_user;
GRANT USAGE ON SCHEMA public TO tienda_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO tienda_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO tienda_user;
